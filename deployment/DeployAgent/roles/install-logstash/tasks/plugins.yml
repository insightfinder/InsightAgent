---
- name: Get list of installed plugins.
  command: >
    ./bin/logstash-plugin list
    chdir={{ logstash_dir }}
  register: logstash_plugins_list
  changed_when: false

- name: Copy json_encode plugin file to server
  copy:
     src: logstash-offline-plugin-json-encode-6.6.0.zip
     dest: /tmp/logstash-offline-plugin-json-encode-6.6.0.zip
- name: Install plugin (json_encode).
  command: >
    ./bin/logstash-plugin install file:////tmp/logstash-offline-plugin-json-encode-6.6.0.zip
    chdir={{ logstash_dir }}
    
- name: Copy Cloudtrail codec plugin file to server
  copy:
     src: logstash-offline-plugin-cloudtrail-codec-6.6.0.zip
     dest: /tmp/logstash-offline-plugin-cloudtrail-codec-6.6.0.zip
  when: agentType=="awsCloudtrail"
- name: Install codec plugin (cloudtrail).
  command: >
    ./bin/logstash-plugin install file:////tmp/logstash-offline-plugin-cloudtrail-codec-6.6.0.zip
    chdir={{ logstash_dir }}
  when: agentType=="awsCloudtrail"
    
- name: Copy Pub/Sub input plugin file to server
  copy:
     src: logstash-offline-plugin-pubsub-input-6.6.0.zip
     dest: /tmp/logstash-offline-plugin-pubsub-input-6.6.0.zip
  when: agentType=="googlePubSub"
- name: Install input plugin (google_pubsub).
  command: >
    ./bin/logstash-plugin install file:////tmp/logstash-offline-plugin-pubsub-input-6.6.0.zip
    chdir={{ logstash_dir }}
  when: agentType=="googlePubSub"

- name: Install configured plugins.
  command: >
    ./bin/logstash-plugin install {{ item }}
    chdir={{ logstash_dir }}
  with_items: "{{ logstash_install_plugins }}"
  when: "item not in logstash_plugins_list.stdout"
  notify: restart logstash
